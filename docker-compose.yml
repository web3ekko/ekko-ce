version: '3'

networks:
  pipeline-network:
    driver: bridge

volumes:
  nats_data:
  redis_data:
  minio_data:
  api_data:

services:
  pipeline:
    build:
      context: ./pipeline
      dockerfile: Dockerfile
    ports:
      - "4195:4195"  # HTTP API + Prometheus metrics
    environment:
      - NATS_URL=nats://nats:4222
      - NATS_STREAM=blockchain
      - NATS_SUBJECT=transactions
    env_file: ".env"
    volumes:
      - ./config.yaml:/app/config.yaml
    restart: unless-stopped
    networks:
      - pipeline-network
    depends_on:
      - nats
      - redis
      - minio
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4195/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  nats:
    image: nats:2.10-alpine
    container_name: nats
    command: --config /etc/nats/nats-server.conf -js -m 8222
    ports:
      - "4222:4222"   # NATS client connections
      - "8222:8222"   # HTTP monitoring
      - "8080:8080"   # WebSocket connections
    volumes:
      - nats_data:/data
      - ./nats-config/nats-server.conf:/etc/nats/nats-server.conf
    networks:
      - pipeline-network
    restart: unless-stopped
    healthcheck:
      # The healthcheck relies on the HTTP monitoring port (8222 by default).
      # If nats-server.conf disables or changes http_port, this might need adjustment.
      # Our current nats-server.conf doesn't explicitly change it, so 8222 should still work.
      test: ["CMD", "curl", "-f", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    # For dev purposes
    command: sh -c "yarn install && yarn dev --host 0.0.0.0 --port 5173"
    ports:
      - "3000:5173"
    environment:
      - NODE_ENV=production
      - NATS_URL=nats://nats:4222
      - API_URL=http://api:8000
    volumes:
      - ./dashboard:/app
      - /app/node_modules
      - /app/.next
    restart: unless-stopped
    networks:
      - pipeline-network
    depends_on:
      - nats
      - api

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - NATS_URL=nats://nats:4222
      - TEST_MODE="true"
      - DUCKDB_PATH=/app/data/ekko.db
      - MIGRATION_MODE="false"
      - ENABLE_JETSTREAM_SYNC="true"
    volumes:
      - ./api:/app
      - api_data:/app/data
    restart: unless-stopped
    networks:
      - pipeline-network
    depends_on:
      - nats

  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - pipeline-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio:
    image: minio/minio
    container_name: minio
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    networks:
      - pipeline-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
